<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="main.css" rel="stylesheet" />
<!-- please host this yourself, referencing github for the demo only -->
<!-- <script src="https://raw.githubusercontent.com/Bandwidth/webrtc-browser/EDGE-602/bundle/0.5.2/BandwidthRtc.bundle.js"></script> -->
<script src="BandRTC-0.5.2.js"></script>
<script src="webrtc_mgr.js"></script>
<script src="audio_analyzer.js"></script>

<div class="outer">
    <div id="sign_on_controls">
        <a href="#" id="signOn" style="font-size: 50px;">Click to Start</a><br />
        Camera: <select id="camSelector" name="camera"><option name="default">Default Camera</option></select><br />
        Mic: <select id="micSelector" name="mic"><option name="default">Default Mic</option></select>
    </div>
    <div id="in_call_controls" style="display:none">
        <a href="#" id="screen_share" style="font-size: 20px;">Screen Share</a><br />
        <a href="#" id="sign_out" style="font-size: 20px;">Leave - TBD</a><br />
    </div>
    <div id="my_video_area"><video id="my_video" playsInline autoPlay></video></div>
    <div id="filmstrip">
    </div>
</div>
<script language="JavaScript">
  var room_name = false;
  window.onload = async function () {
    signOnButton = document.getElementById("signOn");
    signOnButton.onclick = async function () {
      if (room_name == ""){
        room_name = prompt("What room would you like to join?", "lobby")
        if(!room_name){
          room_name = "lobby";
        }
      }
      console.log("Initialize app")
      document.getElementById("sign_on_controls").style.display = "none";
      document.getElementById("in_call_controls").style.display = "block";
      document.getElementById("my_video_area").style.display = "block";
      
      showMyVideo();

      await getOnline({
        caller:{name: "adam"},
        call_type :"app",
        room :room_name, 
        audio: true,
        video: true
      });
    };

    screenShareButton = document.getElementById("screen_share");
    screenShareButton.onclick = async function () {
        await startScreenShare();
    }
    
    // enumerate cameras
    await listCameras("camSelector");
    await listMicrophones("micSelector")

  };



  /**
   * Check for a room in the query string, deep-ish linking
   */
  function checkQueryForRoom() {
    // grab any query string number that might have been passed
    const urlParams = new URLSearchParams(window.location.search);
    const url_room_name = urlParams.get("room");
    if (url_room_name){
      room_name = url_room_name;
    }
  }

/**
 * This is fired off when a new person joins the room
 * Custom function that you implement based on your UI and behavioral needs
 * 
 * @param mediaEl the prebuilt media element, to add to our dom
 * @param rtcStream the actual stream
 */
function onNewStream(mediaEl, rtcStream) {
  // create a block for the stream
  var newStream = document.createElement("div");
  newStream.id = "tile_" + rtcStream.endpointId;
  newStream.style.display = "inline-block";
  newStream.classList.add("tile");

  mediaEl.height = 200;
  newStream.appendChild(mediaEl);

  console.log("new stream is")
  console.log(rtcStream);

  document.getElementById("filmstrip").appendChild(newStream);
  
//   setupAnalyzer(rtcStream.mediaStream);
}

async function showMyVideo(){
  cam_device = document.getElementById(camSelector).value;
  video_constraints = {
      aspectRatio: 1.333,
      frameRate: 30,
      width: { min: 320, max: 640 },
      height: { min: 240, max: 480 },
      resizeMode: "crop-and-scale",
    };
  
  video_constraints.deviceId = { exact: cam_device };

  try{
    const my_stream = await navigator.mediaDevices.getUserMedia({audio: false, video: video_constraints})
    document.getElementById("my_video").srcObject = my_stream;
  } catch (error){
      console.log(`failed to get your video ${error.message}`)
      alert("Sorry, we can't proceed without access to your camera")

  }
  
}

/**
 * Clean up all the DOM elements for the participant that left
 * Custom function that you implement based on your UI and behavioral needs
 * 
 * @param endPointId the id of endpoint that left
 */
 function onEndStream(endPointId) {
  tile = document.getElementById("tile_" + endPointId);
  if(tile) tile.remove();
}

</script>